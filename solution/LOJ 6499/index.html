<!doctype HTML>
<html lang="zh-CN" style="position: fixed; width: 100%; overflow: hidden; ">

<head>
  <meta charset="utf-8">
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<meta name="viewport" content="width=1200">

<title>「雅礼集训 2018 Day2」颜色 - 题解 - Tsuki's blog</title>

<link rel="icon" href="/static/img/favicon.ico" type="image/x-icon" />

<link href="https://cdn.jsdelivr.net/npm/syzoj-public-cdn@1.0.1/cdnjs/semantic-ui/2.4.1/semantic.min.css" rel="stylesheet">

<link href="/static/css/style.css" rel="stylesheet">

<link href="https://cdn.jsdelivr.net/npm/syzoj-public-cdn@1.0.1/google-fonts/fira-mono.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/syzoj-public-cdn@1.0.1/google-fonts/lato.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/syzoj-public-cdn@1.0.1/google-fonts/open-sans.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/syzoj-public-cdn@1.0.1/google-fonts/exo-2.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/syzoj-public-cdn@1.0.1/cdnjs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/syzoj-public-cdn@1.0.1/cdnjs/semantic-ui/2.4.1/semantic.min.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.css" integrity="sha384-9eLZqc9ds8eNjO3TmqPeYcDj8n+Qfa4nuSiGYa6DjLNcv9BtN69ZIulL9+8CqC9Y"
  crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/katex.min.js" integrity="sha384-K3vbOmF2BtaVai+Qk37uypf7VrgBubhQreNQe9aGsz9lB63dIFiQVlJbr92dw2Lx"
  crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/contrib/auto-render.min.js" integrity="sha384-kmZOZB5ObwgQnS/DuDg6TScgOiWWBiVt0plIRkZCmE6rDZGrEOQeHM5PcHi+nyqe"
  crossorigin="anonymous"></script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    renderMathInElement(document.body, {
      delimiters: [
        { left: "$$", right: "$$", display: true },
        { left: "$", right: "$", display: false },
      ]
    });
  });
</script>

<link href="/static/css/hljs.css" rel="stylesheet">
<link href="/static/css/custom.css" rel="stylesheet">
<script src="/static/js/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>

<style type="text/css">
  /* Chart.js */
  @-webkit-keyframes chartjs-render-animation {
    from {
      opacity: 0.99
    }

    to {
      opacity: 1
    }
  }

  @keyframes chartjs-render-animation {
    from {
      opacity: 0.99
    }

    to {
      opacity: 1
    }
  }

  .chartjs-render-monitor {
    -webkit-animation: chartjs-render-animation 0.001s;
    animation: chartjs-render-animation 0.001s;
  }
</style>
</head>

<body style="position: relative; margin-top: 49px; height: calc(100% - 49px); overflow-y: overlay;">
  <div class="ui fixed borderless menu" style="position: fixed; height: 49px; ">
  <div class="ui container">
    <a class="header item" href="/"><span style="font-family: Raleway; font-size: 1.5em; ">Tsuki's blog</span></a>
    <a class="item" href="/"><i class="home icon"></i>首页</a>
    <a class="item active" href="/solutions"><i class="list icon"></i>题解</a>
    <a class="item" href="/articles"><i class="pencil icon"></i>文章</a>
    <a class="item" href="/about"><i class="help circle icon"></i>关于</a>
    <div class="right menu item">
      <div class="ui toggle checkbox" id="dark_theme">
        <link rel="stylesheet" href="" type="text/css" id="dark_theme_style">
        <link rel="stylesheet" href="" type="text/css" id="dark_hljs_style">
        <script>
          if (localStorage.getItem('dark_theme') === '1') {
            document.write('<input type="checkbox" checked>');
            document.getElementById('dark_theme_style').href = '/static/css/dark-theme.css';
            document.getElementById('dark_hljs_style').href = '/static/css/dark-hljs.css';
          } else {
            document.write('<input type="checkbox">');
          }
        </script>
        <script>
          $(function () {
            $('#dark_theme').checkbox('setting', 'onChange', function () {
              let checked = $('#dark_theme').checkbox('is checked');
              localStorage.setItem('dark_theme', checked ? '1' : '0');
              if (checked) {
                document.getElementById('dark_theme_style').href = '/static/css/dark-theme.css';              
                document.getElementById('dark_hljs_style').href = '/static/css/dark-hljs.css';
              } else {
                document.getElementById('dark_theme_style').href = '';
                document.getElementById('dark_hljs_style').href = '';
              }
            });
          });
        </script>
        <label>更换暗色主题</label>
      </div>
    </div>
  </div>
</div>

  <div style="margin-top: 28px; ">
    <div class="ui main container">
      
  <div class="ui center aligned grid">
    
    <div class="row">
      <h1 class="ui header">LOJ #6499. 「雅礼集训 2018 Day2」颜色</h1>
    </div>

    
    <div class="row" style="margin-top: -15px">
          <span class="ui label">内存限制：8 MiB</span>
          <span class="ui label">时间限制：1000 ms</span>
          <span class="ui label">标准输入输出</span>
        </div>

      <div class="row" style="margin-top: -23px">
          <span class="ui label">题目类型：传统</span>
        
          <span class="ui label">评测方式：文本比较</span>
        
      </div>

    <div class="row" style="margin-top: -23px">
      
        <span class="ui label">上传者：未知</span>
      
    </div>
  </div>

  
  <div class="ui grid">
    <div class="row">
      <div class="column">
        <div class="ui buttons">
          <a class="small ui primary button" href="https://loj.ac/problem/6499">原题链接</a>
          <a class="small ui positive button" href="https://raw.githubusercontent.com/cutekibry/cutekibry.github.io-Source/master/content/solutions/LOJ 6499 「雅礼集训 2018 Day2」颜色.md">查看源代码</a>
          <a class="small ui orange button" href="https://github.com/cutekibry/cutekibry.github.io-Source/commits/master/content/solutions/LOJ 6499 「雅礼集训 2018 Day2」颜色.md">修改历史</a>
          <a class="small ui yellow button" href="https://github.com/cutekibry/cutekibry.github.io-Source/blame/master/content/solutions/LOJ 6499 「雅礼集训 2018 Day2」颜色.md">版本对比</a>
          ::after
        </div>
      </div>
    </div>

    

    
      <div class="row">
          <div class="column">
            <h4 class="ui top attached block header">题目描述</h4>
            <div class="ui bottom attached segment font-content">
              <div style="position: relative; overflow: hidden;">
                <p>有 <latex>$n$</latex> 个数字，第 <latex>$i$</latex> 个数字为 <latex>$a_i$</latex>。</p>
<p>有 <latex>$m$</latex> 次询问，每次给出 <latex>$k_i$</latex> 个区间，每个区间表示第 <latex>$l_{i, j}$</latex> 到 <latex>$r_{i, j}$</latex> 个数字，求这些区间中一共出现了多少种不同的数字。</p>
<p>部分数据强制在线。</p>

              </div>
            </div>
          </div>
        </div>
    
    
      <div class="row">
          <div class="column">
            <h4 class="ui top attached block header">输入格式</h4>
            <div class="ui bottom attached segment font-content">
              <div style="position: relative; overflow: hidden;">
                <p>第一行包含三个整数 <latex>$n, m, p$</latex>，<latex>$p$</latex> 为 <latex>$0$</latex> 或 <latex>$1$</latex> 表示是否强制在线。</p>
<p>第二行 <latex>$n$</latex> 个正整数，第 <latex>$i$</latex> 个表示 <latex>$a_i$</latex>。</p>
<p>接下来依次给出每个询问，每个询问第一行一个正整数，表示 <latex>$k_i$</latex>，接下来 <latex>$k_i$</latex> 行，每行两个正整数，分别表示 <latex>$l_{i, j}$</latex> 和 <latex>$r_{i, j}$</latex>，若 <latex>$p = 1$</latex> 且这不是第一个询问，输入的 <latex>$l_{i, j}$</latex> 和 <latex>$r_{i, j}$</latex> 是经过加密的，你需要将这两个数字分别异或上上一个询问的答案，对 <latex>$n$</latex> 取模后再加 <latex>$1$</latex>，两者较小值为真实的 <latex>$l_{i, j}$</latex>，较大值为真实的 <latex>$r_{i, j}$</latex>。</p>

              </div>
            </div>
          </div>
        </div>
    
    
      <div class="row">
          <div class="column">
            <h4 class="ui top attached block header">输出格式</h4>
            <div class="ui bottom attached segment font-content">
              <div style="position: relative; overflow: hidden;">
                <p>对每个询问输出一行一个整数表示答案。</p>

              </div>
            </div>
          </div>
        </div>
    
    
      <div class="row">
          <div class="column">
            <h4 class="ui top attached block header">样例</h4>
            <div class="ui bottom attached segment font-content">
              <div style="position: relative; overflow: hidden;">
                <h4>样例输入 1</h4>
<div class="ui existing segment"><pre><code class="lang-plain">3 2 0
1 2 1
1
1 2
2
1 1
3 3
</code></pre></div>
<h4>样例输出 1</h4>
<div class="ui existing segment"><pre><code class="lang-plain">2
1
</code></pre></div>

              </div>
            </div>
          </div>
        </div>
    
    
      <div class="row">
          <div class="column">
            <h4 class="ui top attached block header">数据范围与提示</h4>
            <div class="ui bottom attached segment font-content">
              <div style="position: relative; overflow: hidden;">
                <p>对于全部数据，<latex>$1 \leq n, m, \sum k_i, a_i \leq 10^5, 1 \leq l_{i, j} \leq r_{i, j} \leq n$</latex>。</p>
<ul>
<li>子任务 <latex>$\rm 1(points:10)$</latex>：<latex>$n, m, \sum k_i, a_i \leq 5000$</latex></li>
<li>子任务 <latex>$\rm 2(points:10)$</latex>：<latex>$n, m, \leq 5000$</latex></li>
<li>子任务 <latex>$\rm 3(points:20)$</latex>：<latex>$k_i = 1$</latex></li>
<li>子任务 <latex>$\rm 4(points:20)$</latex>：<latex>$p = 0$</latex></li>
<li>子任务 <latex>$\rm 5(points:20)$</latex>：<latex>$1 \leq n, m, \sum k_i, a_i \leq 50000$</latex></li>
<li>子任务 <latex>$\rm 6(points:20)$</latex>：无特殊限制</li>
</ul>

              </div>
            </div>
          </div>
        </div>
    
    
      <div class="row">
          <div class="column">
            <h4 class="ui top attached block header">题解</h4>
            <div class="ui bottom attached segment font-content">
              <div style="position: relative; overflow: hidden;">
                <p>在线询问区间整数种数。</p>
<p>我们可以用分块和 Bitset 解决这个问题。预处理出每一块的 Bitset，然后暴力合并即可。</p>
<p>但是这样是 <latex>$O(n + m \cdot \sqrt n \cdot \frac {a_i}{32})$</latex> 的，明显过不去。</p>
<p>对于区间 Bitset 的合并问题，我们可以考虑用线段树或 ST 表解决。在这里，我们需要极其高效的询问，因此我们选择 ST 表，牺牲多一些的预处理复杂度，来达到较快的询问。</p>
<p><del>被卡常卡到心累，块大一点 TLE，块小一点 MLE...</del></p>
<p>时间复杂度：<latex>$O(\sqrt n \cdot \log \sqrt n \cdot \frac {a_i}{32} + m \cdot \frac {a_i}{32} + m \sqrt n)$</latex>。</p>

              </div>
            </div>
          </div>
        </div>
    
    
      <div class="row">
          <div class="column">
            <h4 class="ui top attached block header">代码</h4>
            <div class="ui bottom attached segment font-content">
              <div style="position: relative; overflow: hidden;">
                <div class="ui existing segment"><pre><code class="lang-cpp">#include &lt;algorithm&gt;
#include &lt;cstdio&gt;
#include &lt;cstring&gt;

// #ifdef ONLINE_JUDGE
const int MAXN = 100000 + 10;
const int B = 2000;
// #else
// const int MAXN = 20;
// const int B = 2;
// #endif

const int MAXP = (MAXN &gt;&gt; 5) + 10;
const int BN = MAXN / B + 10;
const int LOGB = 9;

typedef unsigned uint;
typedef uint Bitset[MAXP];

Bitset ansset;
Bitset table[BN][LOGB];
int a[MAXN];
int as[MAXN], bl[BN], br[BN];
char LOG2[BN], COUNT[1 &lt;&lt; 16];
int n, m;
int bn;

inline void read(int &amp;x) {
    char ch;

    do
        ch = getchar();
    while (ch &lt; &#39;0&#39; or ch &gt; &#39;9&#39;);
    x = 0;
    while (ch &gt;= &#39;0&#39; and ch &lt;= &#39;9&#39;) {
        x = (x &lt;&lt; 3) + (x &lt;&lt; 1) + (ch &amp; 15);
        ch = getchar();
    }
}
inline void read(int &amp;a, int &amp;b) {
    read(a);
    read(b);
}
inline void read(int &amp;a, int &amp;b, int &amp;c) {
    read(a);
    read(b);
    read(c);
}
inline void writeln(int x) {
    static char buf[7];
    int top = 0;

    if (!x) {
        putchar(&#39;0&#39;);
        return;
    }
    while (x) {
        top++;
        buf[top] = (x % 10) | 48;
        x /= 10;
    }
    while (top) {
        putchar(buf[top]);
        top--;
    }
    putchar(&#39;\n&#39;);
}

inline void set(Bitset a, int p) { a[p &gt;&gt; 5] |= (1u &lt;&lt; (p &amp; 31)); }
inline void assign(Bitset a, Bitset b) { memcpy(a, b, sizeof(Bitset)); }
inline void assignor(Bitset a, Bitset b) {
    int i;
    for (i = 0; i &lt; MAXP; i++)
        a[i] |= b[i];
}
inline void reset(Bitset a) { memset(a, 0, sizeof(Bitset)); }
inline int count(Bitset a) {
    int i, ans = 0;
    for (i = 0; i &lt; MAXP; i++)
        ans += COUNT[a[i] &gt;&gt; 16] + COUNT[a[i] &amp; (65535)];
    return ans;
}
void init() {
    int i, j, k;

    for (i = 1; i &lt;= B and i &lt;= n; i++)
        as[i] = 1;
    for (i = B + 1; i &lt;= n; i++)
        as[i] = as[i - B] + 1;
    for (i = 1; i * B &lt; n; i++) {
        bl[i] = br[i - 1] + 1;
        br[i] = br[i - 1] + B;
    }
    bl[i] = br[i - 1] + 1;
    br[i] = n;
    bn = i;

    for (i = 1; !(i &gt;&gt; 16); i++)
        COUNT[i] = COUNT[i &gt;&gt; 1] + (i &amp; 1);
    for (i = 2; i &lt;= bn; i++)
        LOG2[i] = LOG2[i &gt;&gt; 1] + 1;

    for (i = 1; i &lt;= bn; i++)
        for (j = bl[i]; j &lt;= br[i]; j++)
            set(table[i][0], a[j]);

    for (j = 1, k = 2; k &lt;= bn; j++, k &lt;&lt;= 1) {
        for (i = 1; i + k - 1 &lt;= bn; i++) {
            assign(table[i][j], table[i][j - 1]);
            assignor(table[i][j], table[i + (k &gt;&gt; 1)][j - 1]);
        }
    }
}

void query(int l, int r) {
    int i, j, xl, xr;

    if (as[l] == as[r])
        for (i = l; i &lt;= r; i++)
            set(ansset, a[i]);
    else {
        for (i = l; i &lt;= br[as[l]]; i++)
            set(ansset, a[i]);
        for (i = r; i &gt;= bl[as[r]]; i--)
            set(ansset, a[i]);
        xl = as[l] + 1;
        xr = as[r] - 1;
        if (xl &lt;= xr) {
            j = LOG2[xr - xl + 1];
            assignor(ansset, table[xl][j]);
            assignor(ansset, table[xr - (1 &lt;&lt; j) + 1][j]);
        }
    }
}

int main() {
#ifndef ONLINE_JUDGE
    freopen(&quot;6499.in&quot;, &quot;r&quot;, stdin);
    freopen(&quot;6499.out&quot;, &quot;w&quot;, stdout);
#endif

    int i, j, k, l, r;
    int type;
    int lastans = 0;

    read(n, m, type);
    for (i = 1; i &lt;= n; i++)
        read(a[i]);
    init();
    for (i = 1; i &lt;= m; i++) {
        reset(ansset);

        read(k);
        while (k) {
            read(l, r);
            if (type and i &gt; 1) {
                l = (l ^ lastans) % n + 1;
                r = (r ^ lastans) % n + 1;
            }
            if (l &gt; r)
                std::swap(l, r);
            query(l, r);
            k--;
        }

        lastans = count(ansset);
        writeln(lastans);
    }

    // printf(&quot;%lu\n&quot;, sizeof(table));
    return 0;
}
</code></pre></div>

              </div>
            </div>
          </div>
        </div>
    
  </div>
  
  <div style="height: 120px"></div>
<script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script src='//unpkg.com/valine/dist/Valine.min.js'></script>
<div id="vcomments"></div>
<script>
  new Valine({
    el: '#vcomments',
    appId: 'ag8HLEJ5i9Pu4EbbfVEejxYY-gzGzoHsz',
    appKey: 'TjVP6wlGquVVCLQjHql57cs4',
    notify: false,
    verify: false,
    avatar: 'mm',
    placeholder: 'Enter text'
  });
</script>

    </div>
    <div class="ui vertical footer segment" style="margin-top: 15px; ">
  <div class="ui center aligned container">
    <span style="color: #999;">
      Theme Based on <a href="https://loj.ac" target="_blank">LibreOJ</a>. <br />
      Last build: 2019-12-14 23:23:11.
    </span>
  </div>
</div>
  </div>
</body>

</html>